library(dplyr)
library(redcapAPI)
library(stringr)

source("../../../common/s2_functions.R")
randomization_codes <- read.csv("../../../common/s2_randomization_codes.csv",
                                stringsAsFactors = FALSE)

# load data
uvm_rcon <- build_rcon("uvm")
brown_rcon <- build_rcon("brown")
jhu_rcon <- build_rcon("jhu")

fields <- "screen_id"
events <- NULL

uvm <- download_rc_dataframe(uvm_rcon, fields, events)
brown <- download_rc_dataframe(brown_rcon, fields, events)
jhu <- download_rc_dataframe(jhu_rcon, fields, events)
# 
df <- rbind(uvm, brown, jhu)
# df <- uvm

# manipulate data
df <- clean_sid(df) # remove all invalid and '-2' subject IDs
df <- merge(df, randomization_codes)
df <- pjtstedse(df) # impose project, site, and dose condition
df <- clean_rc_event(df)

# write data frame to file
write.csv(df, "../output/project_data.csv", row.names = FALSE)